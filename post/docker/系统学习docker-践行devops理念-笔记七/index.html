<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes - LI的技术笔记</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">


  <meta name="description" content="容器编排Kubernetes，是课程第九章的内容
" />
<meta name="keywords" content="docker" />







<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E4%B8%83/" />





<link rel="icon" href="https://liguoqinjim.cn/favicon.ico" />











<link rel="stylesheet" href="https://liguoqinjim.cn/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes" />
<meta property="og:description" content="容器编排Kubernetes，是课程第九章的内容" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E4%B8%83/" />
<meta property="article:published_time" content="2018-08-30T15:28:22+08:00" />
<meta property="article:modified_time" content="2018-08-30T15:28:22+08:00" />
<meta itemprop="name" content="系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes">
<meta itemprop="description" content="容器编排Kubernetes，是课程第九章的内容">


<meta itemprop="datePublished" content="2018-08-30T15:28:22&#43;08:00" />
<meta itemprop="dateModified" content="2018-08-30T15:28:22&#43;08:00" />
<meta itemprop="wordCount" content="440">



<meta itemprop="keywords" content="docker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes"/>
<meta name="twitter:description" content="容器编排Kubernetes，是课程第九章的内容"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-113128130-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="https://liguoqinjim.cn/" class="logo">LI的技术笔记</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/liguoqinjim" rel="noopener" target="_blank">
              Works
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/tags/">Tags</a>
          
        
      </li>
    

    
  </ul>
</nav>


  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="https://liguoqinjim.cn/" class="logo">
    
      LI的技术笔记
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/liguoqinjim" rel="noopener" target="_blank">
              Works
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/tags/">Tags</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes</h1>
      
      <div class="post-meta">
        <time datetime="2018-08-30" class="post-time">
          2018-08-30
        </time>
        <div class="post-category">
            <a href="https://liguoqinjim.cn/categories/docker/"> docker </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#1-kubenetes简介">1.Kubenetes简介</a>
<ul>
<li><a href="#1-1为什么简写是k8s">1.1为什么简写是k8s</a></li>
</ul></li>
<li><a href="#2-minikube快速搭建k8s单节点环境">2.Minikube快速搭建K8S单节点环境</a>
<ul>
<li><a href="#2-1配置k8s环境">2.1配置K8S环境</a></li>
<li><a href="#2-2安装kubetcl">2.2安装kubetcl</a></li>
<li><a href="#2-3minikube">2.3minikube</a></li>
<li><a href="#2-4kubectl">2.4kubectl</a></li>
</ul></li>
<li><a href="#3-k8s最小调度单位pod">3.K8S最小调度单位Pod</a>
<ul>
<li><a href="#notice">NOTICE</a></li>
</ul></li>
<li><a href="#4-replicaset和replicationcontroller">4.ReplicaSet和ReplicationController</a>
<ul>
<li><a href="#notice-1">NOTICE</a></li>
</ul></li>
<li><a href="#5-deployment">5.Deployment</a>
<ul>
<li><a href="#notice-2">NOTICE</a></li>
</ul></li>
<li><a href="#6-使用tectonic在本地搭建多节点k8s集群">6.使用Tectonic在本地搭建多节点K8S集群</a>
<ul>
<li><a href="#notice-3">NOTICE</a></li>
</ul></li>
<li><a href="#7-k8s基础网络cluster-network">7.k8s基础网络Cluster Network</a></li>
<li><a href="#8-service简介和演示">8.Service简介和演示</a>
<ul>
<li><a href="#8-1不要直接使用和管理pods">8.1不要直接使用和管理Pods</a></li>
<li><a href="#8-2service">8.2Service</a></li>
</ul></li>
<li><a href="#9-nodeport类型service以及label的简单实用">9.NodePort类型Service以及Label的简单实用</a>
<ul>
<li><a href="#9-1nodeport类型service">9.1NodePort类型Service</a></li>
<li><a href="#9-2label">9.2Label</a></li>
<li><a href="#notice-4">NOTICE</a></li>
</ul></li>
<li><a href="#10-准备工作-使用kops在亚马逊aws上搭建k8s集群">10.准备工作——使用kops在亚马逊AWS上搭建k8s集群</a></li>
<li><a href="#11-使用kops在亚马逊aws上搭建k8s集群">11.使用kops在亚马逊AWS上搭建k8s集群</a></li>
<li><a href="#12-loadblancer类型service以及aws的dns服务配置">12.LoadBlancer类型Service以及AWS的DNS服务配置</a></li>
<li><a href="#13-在亚马逊k8s集群上部署wordpress">13.在亚马逊k8s集群上部署wordpress</a></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>容器编排Kubernetes，是课程第九章的内容</p>

<!--toc-->

<h1 id="1-kubenetes简介">1.Kubenetes简介</h1>

<p><img src="https://liguoqinjim.cn/images/docker/note7/k8s.png" alt="k8s" /></p>

<h2 id="1-1为什么简写是k8s">1.1为什么简写是k8s</h2>

<p>因为kubernetes，k和s之间一共有8个字母</p>

<h1 id="2-minikube快速搭建k8s单节点环境">2.Minikube快速搭建K8S单节点环境</h1>

<h2 id="2-1配置k8s环境">2.1配置K8S环境</h2>

<ol>
<li><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">https://github.com/kelseyhightower/kubernetes-the-hard-way</a>
这个是k8s的从头开始安装的方法</li>
<li><a href="https://github.com/kubernetes/minikube">https://github.com/kubernetes/minikube</a>
这个是在本地跑一个最简单的k8s，只有一个节点。类似vagrant，是要借助virtual box这种的</li>
</ol>

<h2 id="2-2安装kubetcl">2.2安装kubetcl</h2>

<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>

<h2 id="2-3minikube">2.3minikube</h2>

<p>minikube相关命令：</p>

<ol>
<li>minikube start，启动minikube节点</li>
<li>minikube ssh，连接到minikube内部</li>
<li>minikube stop</li>
</ol>

<h2 id="2-4kubectl">2.4kubectl</h2>

<p>kubectl context:<br />
里面存着一个kubernetes集群的信息，比如集群的host。kubectl下可能有多个context，我们可以通过context去管理多个k8s集群</p>

<p>相关命令：</p>

<ol>
<li>kubectl config view</li>
<li>kubectl config get-contexts，得到现在是用的哪个context</li>
<li>kubectl cluster-info，得到集群信息</li>
<li>kubectl version</li>
</ol>

<h1 id="3-k8s最小调度单位pod">3.K8S最小调度单位Pod</h1>

<p>k8s不对容器进行操作，因为最小单位是pod。同一个pod里面的容器，是在一个namespace下的，这里的namespace包括所有的namespace(如network namespace)</p>

<p>相关命令：</p>

<ul>
<li>kubectl create -f pod_nginx.yml，创建pod</li>
<li>kubectl delete -f pod_nginx.yml，删除pod</li>
<li>kubectl get pods，查看pods的情况</li>
<li>kubectl get pods -o wide，加了wide参数之后，会显示更多信息</li>
<li>上面的命令，可以看到pod里面的容器具体是在哪个机器上的，要进入这个容器，我们先ssh到这个机器上，然后docker exec -it container_name sh，</li>
<li>kubectl describe pods nginx，查看pods的具体信息</li>
<li>kubectl port-forward nginx 8080:80，映射本地的8080端口和pod的80端口，nginx是pod name，但是要注意的是，这个命令一旦ctrl+c退出，映射就结束了。8080端口是运行了kubectl的机器的端口，不是pod所在的容器的端口。</li>
</ul>

<p>pod_nginx.yml：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx <span style="color:#75715e">#使用的镜像</span>
    ports:
    - containerPort: <span style="color:#ae81ff">80</span></code></pre></div>
<h2 id="notice">NOTICE</h2>

<p>kubectl create之后，可能pod会一直不启动，这个时候可以通过minikube logs查看错误日志。我遇到的问题的是不能拉取镜像，是要翻墙的网址。
解决这个问题可以在启动minikube的时候，指定代理：</p>

<pre><code>minikube start --docker-env=HTTP_PROXY=http://$YOURPROXY:PORT \
                 --docker-env=HTTPS_PROXY=https://$YOURPROXY:PORT
</code></pre>

<p>参考资料：<a href="https://github.com/kubernetes/minikube/blob/master/docs/http_proxy.md">https://github.com/kubernetes/minikube/blob/master/docs/http_proxy.md</a></p>

<h1 id="4-replicaset和replicationcontroller">4.ReplicaSet和ReplicationController</h1>

<p>ReplicaSet是新一代的ReplicationController。这里的replica就是我们之前docker里面遇到的是一样的。也是多个，这里就是多个pod。下面简称rc或者rs</p>

<p>相关命令：</p>

<ul>
<li>kubectl create -f rc_nginx.yml，创建replicationController，rc_nginx.yml见docker_labs</li>
<li>kubectl get rc，可以查看rc的情况</li>
<li>kubectl get pods，查看pod的情况</li>
<li>kubectl delete pods nginx-6cznp，删除这个一个pod</li>
<li>kubectl scale rc nginx &ndash;replicas=2，修改rc的pod数量</li>
<li>kubectl delete rc nginx，删除replicationController
-kubectl create -f rs_nginx.yml，创建replicaSet，ns_nginx.yml见docker-labs</li>
<li>kubectl get rs，查看rs的情况</li>
<li>kubectl scale rs nginx &ndash;replicas=2，对rs进行scale</li>
</ul>

<p>rc_nginx.yml：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: ReplicationController
metadata:
  name: nginx
spec:
  replicas: <span style="color:#ae81ff">3</span>
  selector:
    app: nginx
  template:
    metadata:
      name: nginx
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx <span style="color:#75715e">#使用nginx镜像</span>
        ports:
        - containerPort: <span style="color:#ae81ff">80</span></code></pre></div>
<p>rs_nginx.yml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx
  labels:
    tier: frontend
spec:
  replicas: <span style="color:#ae81ff">3</span>
  selector:
    matchLabels:
      tier: frontend
  template:
    metadata:
      name: nginx
      labels:
        tier: frontend
    spec:
      containers:
      - name: nginx
        image: nginx <span style="color:#75715e">#使用nginx镜像</span>
        ports:
        - containerPort: <span style="color:#ae81ff">80</span></code></pre></div>
<h2 id="notice-1">NOTICE</h2>

<p>要是我们在rc或者rs下创建pod，然后我们去强制删除这个pod，删除之后，rc和rs会自动再去创建一个pod。rc和rs会保持pod的数量，所以就算只创建一个pod，也推荐使用rc或者rs。因为这会保持pod的数量。</p>

<h1 id="5-deployment">5.Deployment</h1>

<p>Deployment描述了一种希望的状态，是对pods和replicaset的希望达到的一个状态。比如我希望这个replicaset是有3个replica的，pods的image是nginx。之后我们要修改的话，只要把希望的状态改变，deployment就会自动帮我们完成。
需要注意的是，我们通过deployment创建的replicaset和pod，创建了之后，我们就不能独立的对replicaset和pod进行删除了，我们一定要对deployment进行操作</p>

<p>相关命令：</p>

<ol>
<li>kubectl create -f deployment_nginx.yml，创建deployment，详见docker-lab</li>
<li>kubectl get deployment，得到deployment的情况</li>
<li>kubectl get deployment -o wide，得到详细情况</li>
<li>kubectl set image deployment nginx-deployment nginx=nginx:1.13，更新镜像，nginx-deployment是deployment的name，nginx:1.13是新的镜像</li>
<li>kubectl rollout history deployment nginx-deployment，查看deployment的历史版本</li>
<li>kubectl rollout undo deployment nginx-deployment，撤销之前的操作，比如我们先更新了一个镜像，然后我们使用undo，就会变回原来的镜像了</li>
<li>kubectl get node -o wide，查看k8s node的情况</li>
<li>kubectl expose deployment nginx-deployment &ndash;type=NodePort，会暴露到node的一个随机端口上，是暴露到最终运行pod的机器上，不是运行kubectl的机器上，具体可以看9-8</li>
<li>kubectl get services，查看services的情况，因为我们用了8的命令，所以service会随机一个端口绑定到容器的80端口。是绑定到最终运行pod的node上的，不是运行kubectl的机器</li>
<li>kubectl delete service nginx-deployment，删除service</li>
</ol>

<p>deployment_nginx.yml：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: <span style="color:#ae81ff">3</span>
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:<span style="color:#ae81ff">1.12.2</span> <span style="color:#75715e">#先指定这个版本的nginx,之后可以更新</span>
        ports:
        - containerPort: <span style="color:#ae81ff">80</span></code></pre></div>
<h2 id="notice-2">NOTICE</h2>

<p>deployment下的replicaset和pods的name，replicaset的前缀是deployment的name，pods的name的前缀是replicaset的name</p>

<h1 id="6-使用tectonic在本地搭建多节点k8s集群">6.使用Tectonic在本地搭建多节点K8S集群</h1>

<p>tectonic的脚本详见docker-lab，要注意的是，vagrant up的时候用的脚本，访问的基本都是被墙的网址，在脚本里面设置代理很麻烦，我最后是直接在路由器上安装了代理，才安装好。</p>

<p>相关命令：</p>

<ol>
<li>kubectl config get-contexts，查看kubectl的context</li>
<li>kubectl config use-context tectonic，切换到tectonic这个context</li>
</ol>

<h2 id="notice-3">NOTICE</h2>

<p>我一开始用kubectl_1.11的版本使用命令kubectl get nodes的时候，会返回错误，然后我就用了kubectl的1.8这个版本，就正确了。</p>

<p>参考资料：<a href="https://github.com/kubernetes/kubernetes/issues/65575">https://github.com/kubernetes/kubernetes/issues/65575</a></p>

<h1 id="7-k8s基础网络cluster-network">7.k8s基础网络Cluster Network</h1>

<p><img src="https://liguoqinjim.cn/images/docker/note7/k8s_network.png" alt="k8s_network" /></p>

<p>这个flannel其实是一个k8s的网络插件，也可以不用flannel，可以用的别的网络插件。
k8s的网络插件，要符合最基本的3个规则，详见：<br />
<a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">https://kubernetes.io/docs/concepts/cluster-administration/networking/</a></p>

<h1 id="8-service简介和演示">8.Service简介和演示</h1>

<h2 id="8-1不要直接使用和管理pods">8.1不要直接使用和管理Pods</h2>

<p><img src="https://liguoqinjim.cn/images/docker/note7/pods.png" alt="pods" /></p>

<p>这里创建新的pods倒是没问题，但是最关键的是，新创建的pod可能ip会变。我们现在打个比方，我有两个pod，一个是nginx，还有一个是db，现在我db的pod被terminated然后创建了一个新的。这个时候要是db的ip变了，nginx是没办法修改的。所以我们需要用到service来解决这个问题，service就会给一个不变的ip和pod的ip相当于映射住，service的ip是不变的。那我们访问service的ip就可以了。然后我们要是用deployment这种，replica设成多个，我们可以在deployment上创建service，那么这个service会自动帮我们在多个replica之间做负载均衡。</p>

<h2 id="8-2service">8.2Service</h2>

<p><img src="https://liguoqinjim.cn/images/docker/note7/services.png" alt="services" /></p>

<p>本节课说的是ClusterIP的，这种service是在cluster内部，任何一台机器都可以访问的，但是也仅限于cluster内部</p>

<p>相关命令：</p>

<ol>
<li>kubectl expose pods nginx-pod，创建service，默认是ClusterIP</li>
<li>kubectl get svc/services，svc是简写</li>
<li>kubectl expose deployment service-test，在deployment上创建一个service，会为deployment里面的pods自动做负载均衡</li>
<li>kubectl edit deployment service-test，这样可以更新service-test这个deployment的配置，然后k8s会帮我们自己更新</li>
</ol>

<h1 id="9-nodeport类型service以及label的简单实用">9.NodePort类型Service以及Label的简单实用</h1>

<h2 id="9-1nodeport类型service">9.1NodePort类型Service</h2>

<p>创建NodePort的service，有两种方式，一种用命令创建，一种是用yml文件来创建。
NodePort是可以给外网访问的，而且是集群内，所有node的ip加上这个service的port都可以访问。NodePort的端口是有范围的，是从30000-32767</p>

<p>用命令创建：</p>

<ol>
<li>kubectl create -f pod_nginx.yml，创建pod_nginx，yml见docker-lab</li>
<li>kubectl expose pods nginx-pod &ndash;type=NodePort，创建NodePort的service</li>
<li>kubectl get svc，查看创建的sevice，注意，在service我们会看到NodePort类型的service，会随机一个端口映射到pod的端口。这个时候所有node的ip+这个端口，就可以访问pod</li>
</ol>

<p>用文件创建：</p>

<p>pod_nginx.yml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx-container
    image: nginx
    ports:
    - name: nginx-port <span style="color:#75715e">#这个name，service_nginx.yml里面会使用到</span>
      containerPort: <span style="color:#ae81ff">80</span></code></pre></div>
<p>service_nginx.yml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  ports:
  - port: <span style="color:#ae81ff">32333</span>
    nodePort: <span style="color:#ae81ff">32333</span>
    targetPort: nginx-port <span style="color:#75715e">#pod_nginx.yml里面的ports下的name</span>
    protocol: TCP
  selector:
    app: nginx <span style="color:#75715e"># label</span>
  type: NodePort</code></pre></div>
<ol>
<li>targetPort后面要跟pod的yml文件里面的ports下的name</li>
<li>selector后面的值是label的key和value，通过这个值去选择有这个label的pod去创建这个service</li>
</ol>

<h2 id="9-2label">9.2Label</h2>

<p>k8s里面，几乎所有的resource，如pod，deployment等等，我们都可以设置标签。比如我们可以指定nodeSelector，那么我们在创建pod的时候，就可以指定我们这个pod是要创建在哪个node上。</p>

<p>相关命令：</p>

<ol>
<li>kubectl label node w1.tectonicsandbox.com hardware=good，这个就是给w1这个node添加了一个label</li>
<li>kubectl get node &ndash;show-labels，可以查看label</li>
</ol>

<h2 id="notice-4">NOTICE</h2>

<ol>
<li>在生产环境里面，ClusterIP因为只能在cluster内部访问，外部是不能访问的，所以不会用。NodePort的端口又是有限的，所以一般也不会使用，但是是可以使用的。</li>
<li>NodePort的端口是有范围的，是从30000-32767</li>
</ol>

<h1 id="10-准备工作-使用kops在亚马逊aws上搭建k8s集群">10.准备工作——使用kops在亚马逊AWS上搭建k8s集群</h1>

<p>kops: <a href="https://github.com/kubernetes/kops">https://github.com/kubernetes/kops</a></p>

<h1 id="11-使用kops在亚马逊aws上搭建k8s集群">11.使用kops在亚马逊AWS上搭建k8s集群</h1>

<p>使用kops，在AWS创建k8s集群</p>

<h1 id="12-loadblancer类型service以及aws的dns服务配置">12.LoadBlancer类型Service以及AWS的DNS服务配置</h1>

<p>service里面还有一个类型是，loadblancer，这个类型是需要云服务商的支持的，本地是没法测试的。这个service会给出一个url，然后加上给出的端口就可以访问了。因为这个url会很长，所以我们还可以使用dns来添加ANAME来映射到一个短的sub domain</p>

<h1 id="13-在亚马逊k8s集群上部署wordpress">13.在亚马逊k8s集群上部署wordpress</h1>

<p>略</p>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://liguoqinjim.cn/tags/docker/">docker</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E5%85%AB/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">系统学习Docker 践行DevOps理念 笔记(八)|容器的的运维和监控</span>
            <span class="prev-text nav-mobile"></span>
          </a>
        
          <a class="next" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E5%85%AD/">
            <span class="next-text nav-default">系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm</span>
            <span class="prev-text nav-mobile"></span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E4%B8%83/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'liguoqinjim';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


<a href="https://liguoqinjim.cn/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.
        
      </span></span>

  
  

  
    <span>
      <a href='http://www.beian.miit.gov.cn'>沪ICP备19042199号-1</a>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="https://liguoqinjim.cn/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://liguoqinjim.cn/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="https://liguoqinjim.cn/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>


























</body>
</html>
