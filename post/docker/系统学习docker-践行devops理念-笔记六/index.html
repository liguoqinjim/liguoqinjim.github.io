<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm - LI的技术笔记</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">


  <meta name="description" content="容器编排Docker Swarm，是课程第七章的内容
" />
<meta name="keywords" content="docker" />







<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E5%85%AD/" />





<link rel="icon" href="https://liguoqinjim.cn/favicon.ico" />











<link rel="stylesheet" href="https://liguoqinjim.cn/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm" />
<meta property="og:description" content="容器编排Docker Swarm，是课程第七章的内容" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E5%85%AD/" />
<meta property="article:published_time" content="2018-08-29T17:40:55+08:00" />
<meta property="article:modified_time" content="2018-08-29T17:40:55+08:00" />
<meta itemprop="name" content="系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm">
<meta itemprop="description" content="容器编排Docker Swarm，是课程第七章的内容">


<meta itemprop="datePublished" content="2018-08-29T17:40:55&#43;08:00" />
<meta itemprop="dateModified" content="2018-08-29T17:40:55&#43;08:00" />
<meta itemprop="wordCount" content="430">



<meta itemprop="keywords" content="docker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm"/>
<meta name="twitter:description" content="容器编排Docker Swarm，是课程第七章的内容"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-113128130-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="https://liguoqinjim.cn/" class="logo">LI的技术笔记</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/liguoqinjim" rel="noopener" target="_blank">
              Works
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/tags/">Tags</a>
          
        
      </li>
    

    
  </ul>
</nav>


  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="https://liguoqinjim.cn/" class="logo">
    
      LI的技术笔记
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/liguoqinjim" rel="noopener" target="_blank">
              Works
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://liguoqinjim.cn/tags/">Tags</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">系统学习Docker 践行DevOps理念 笔记(六)|容器编排Docker Swarm</h1>
      
      <div class="post-meta">
        <time datetime="2018-08-29" class="post-time">
          2018-08-29
        </time>
        <div class="post-category">
            <a href="https://liguoqinjim.cn/categories/docker/"> docker </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#1-容器编排swarm介绍">1.容器编排Swarm介绍</a></li>
<li><a href="#2-创建一个三节点的swarm集群">2.创建一个三节点的swarm集群</a></li>
<li><a href="#3-service的创建维护和水平扩展">3.Service的创建维护和水平扩展</a>
<ul>
<li><a href="#notice">NOTICE</a></li>
</ul></li>
<li><a href="#4-在swarm集群里通过service部署wordpress">4.在swarm集群里通过service部署wordpress</a>
<ul>
<li><a href="#notice-1">NOTICE</a></li>
</ul></li>
<li><a href="#5-集群服务间通信之routing-mesh">5.集群服务间通信之Routing Mesh</a>
<ul>
<li><a href="#notice-2">NOTICE</a></li>
</ul></li>
<li><a href="#6-routing-mesh之ingress负载均衡">6.Routing Mesh之Ingress负载均衡</a></li>
<li><a href="#7-docker-stack部署wordpress">7.Docker Stack部署Wordpress</a></li>
<li><a href="#8-作业解答之部署投票应用">8.作业解答之部署投票应用</a>
<ul>
<li><a href="#8-1stack可视化">8.1stack可视化</a></li>
</ul></li>
<li><a href="#9-docker-secret管理和使用">9.Docker Secret管理和使用</a>
<ul>
<li><a href="#9-1什么是secret">9.1什么是Secret</a></li>
<li><a href="#9-2secret存在哪里">9.2Secret存在哪里</a></li>
<li><a href="#9-3使用方法">9.3使用方法</a></li>
</ul></li>
<li><a href="#10-docker-secret在stack中的使用">10.Docker Secret在Stack中的使用</a></li>
<li><a href="#11-service更新">11.Service更新</a>
<ul>
<li><a href="#11-1更新镜像">11.1更新镜像：</a></li>
<li><a href="#11-2更新端口">11.2更新端口：</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>容器编排Docker Swarm，是课程第七章的内容</p>

<!-- toc -->

<h1 id="1-容器编排swarm介绍">1.容器编排Swarm介绍</h1>

<p>Swarm是Docker自带的，不需要额外安装
<img src="https://liguoqinjim.cn/images/docker/note6/swarm.png" alt="swarm" /></p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/swarm2.png" alt="swarm_2" />
Swarm里面有两种节点，一种是Manager节点，还有一种是Worker节点。
一般Container是运行在Worker上的，但是Manager节点上也是可以运行的，只是一般不这么做</p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/swarm3.png" alt="swarm_3" /></p>

<h1 id="2-创建一个三节点的swarm集群">2.创建一个三节点的swarm集群</h1>

<ol>
<li><code>docker swarm init --advertise-addr=192.168.205.10</code><br />
这个命令要在准备作为manager节点的机器上来运行，运行这个命令的就是manager节点了,ip就是本机的ip，运行完成之后，会返回命令2</li>
<li><code>docker swarm join --token SWMTKN-1-1rbdry31gxzz2u0nsbrqa5xkkd31lw83dpj5jife62xhqclbpr-151fu5csqw3ombtkm19jp9vej 192.168.205.10:2377</code><br />
这个命令都是命令1里面返回的，我们直接到worker节点的机器上运行就可以了</li>
<li><code>docker node ls</code>，查看现在的集群情况，这个命令要在manager节点上运行</li>
</ol>

<h1 id="3-service的创建维护和水平扩展">3.Service的创建维护和水平扩展</h1>

<p>相关命令：</p>

<ul>
<li><code>docker service create --name demo busybox sh -c &quot;while true; do sleep 3600; done&quot;，</code>这个就是启动一个service，相当于与docker run</li>
<li><code>docker service ls</code>，查看所有service的情况</li>
<li><code>docker service ps demo</code>，查看某个service的情况，可以看到运行在哪个节点上</li>
<li><code>docker service rm demo</code>，删除service，但是容器被删除会有一点延迟</li>
<li><code>docker service scale demo=3</code>，横向扩展，也就是demo这个service的replicas会变成3，</li>
</ul>

<h2 id="notice">NOTICE</h2>

<ol>
<li>docker service ls命令返回结果里面的REPLICAS，都是&rdquo;<sup>3</sup>&frasl;<sub>3</sub>&rdquo;这样，分母表示总共有总数，分子表示现在有多少已经ready了</li>
<li>假设replicas我们设置为了5，那么swarm会自动帮我们去创建5个container，这时候，我们使用docker rm -f强制删除一个容器。我们会看到replicas会变成4/5，但是过一会又会变成5/5，因为swarm会确保我们的replicas个数。4/5的时候，swarm会自动帮我们再创建一个。</li>
</ol>

<h1 id="4-在swarm集群里通过service部署wordpress">4.在swarm集群里通过service部署wordpress</h1>

<p>部署过程：</p>

<ol>
<li>docker network create demo -d overlay，在集群里面创建overlay的网络，name为demo</li>
<li>docker service create &ndash;name mysql &ndash;network demo &ndash;env MYSQL_ROOT_PASSWORD=xphone123 &ndash;env MYSQL_DATABASE=wordpress &ndash;mount type=volume,source=mysql-data,destination=/var/lib/mysql mysql
这个是创建mysql这个service的命令，&ndash;mount就是我们的docker run里面使用的-v命令，source=mysql-data指定的就是volume name，要注意docker run和docker service create里面的有些参数是不一样的</li>
<li>docker service create &ndash;name wordpress -p 80:80 &ndash;env WORDPRESS_DB_PASSWORD=xphone123 &ndash;env WORDPRESS_DB_HOST=mysql &ndash;network demo wordpress，这个是创建wordpress的命令，WORDPRESS_DB_HOST的值等于mysql，这个mysql就是service的name，也就是之前ping mysql会得到那个地址的逻辑。</li>
</ol>

<h2 id="notice-1">NOTICE</h2>

<p>我们在运行了上面命令之后，我们可以通过docker service ps wordpress看到这个service是运行在哪个节点上面的，我们可以访问这个节点的ip，然后就看到了wordpress页面，这个是肯定的。但是这里要注意，我们这时候去访问其他两个节点的ip，也是可以看到wordpress页面的。原理在7-5，7-6里面</p>

<h1 id="5-集群服务间通信之routing-mesh">5.集群服务间通信之Routing Mesh</h1>

<p>命令:</p>

<ol>
<li>docker network create demo -d overlay</li>
<li>docker service create &ndash;name whoami -p 8000:8000 &ndash;network demo -d jwilder/whoami</li>
<li>docker service create &ndash;name client -d &ndash;network demo busybox sh -c &ldquo;while true; do sleep 3600; done&rdquo;</li>
</ol>

<p>上面的命令都运行好之后，我们现在应该是两个容器。我们进入client这个service的容器里面，我们ping whoami，是会通的，会得到一个地址，这里我们假设是10.0.0.9。<br />
然后我们运行一个命令，docker service scale whoami=2，那么现在whoami这个service下面就有两个容器了。<br />
我们还是在client里面ping whoami，这个时候我们发现，ping的通，但是ip还会是10.0.0.9。<br />
那这里就有个问题了，whoami这个service有两个容器，我们到底ping的是哪个？<br />
其实这个10.0.0.9，这个其实不是哪个容器的ip，这个是vip，也就是一个虚拟ip，容器有另外的ip。我们可以使用nslookup查看tasks.whoami，我们就看到了真实的ip。或者我们在client容器里面运行traceroute tasks.whoami，我们可以看到每次的结果可能是不一样的。因为docker会自动为我们在service里面负载均衡。发送给10.0.0.9的这个vip的流量会被分配到每个容器的真实ip上。</p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/routingMesh.png" alt="routingMesh" /></p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/loadBalancing.png" alt="loadBalancing" /></p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/ipvs.png" alt="IPVS" /></p>

<h2 id="notice-2">NOTICE</h2>

<ol>
<li>nslookup whoami，这个可以看到vip是多少</li>
<li>nslookup tasks.whoami，可以看到vip之后的所有真实ip是多少</li>
<li>容器里面的nslookup可能会有问题，也就是找不到这个dns记录，这个时候我们可以使用<code>traceroute tasks.servicename</code>来解决</li>
<li>LVS可以就认为是IPVS，因为现在IPVS是LVS的一部分</li>
</ol>

<h1 id="6-routing-mesh之ingress负载均衡">6.Routing Mesh之Ingress负载均衡</h1>

<p>Routing Mesh两种体现里面的另一个，Ingress Network。这个是可以把服务端口暴露到每个swarm节点上，和7-5里面的不一样。
<img src="https://liguoqinjim.cn/images/docker/note6/ingress.png" alt="ingress" /></p>

<p>试验步骤：<br />
试验用swarm集群情况，还是上面的集群，两个whoami，一个client，whoami开放了一个8000端口，并且映射到了本地</p>

<ol>
<li>curl 127.0.0.1:8000，本机运行这个命令，发现背后有负载均衡。因为每次的返回会不一样，是从不一样的容器返回的，因为现在有两个whoami容器</li>
<li>sudo iptables -nL -t nat，查看端口的情况，查看本地的转发规则
可以看到有一行，tcp dpt:8000 to:172.18.0.2:8000，也就是8000端口的流量，会转发到172.18.0.2:8000</li>
<li>我们可以在本机ip a，可以看到一个172.18.0.1，docker_gwbridge这个network，和2里面的转发的ip是一个网段里面的</li>
<li>brctl show</li>
<li>docker network inspect docker_gwbridge，查看这个network的情况，会看到172.18.0.2这个ip，属于一个ingress-sbox，它其实是一个network的namespace。我们可以用命令6来查看</li>
<li>sudo ls /var/run/docker/netns，查看namespace</li>
<li>sudo nsenter &ndash;net=/var/run/docker/netns/ingress_sbox，进入这个namespace，然后我们会发现，我们进入了ingress_sbox这个namespace，我们运行ip a，就是172.18.0.2</li>
<li>iptables -nL -t mangle，查看这个namespace的iptables，会发现有一行
tcp dpt:8000 MARK set 0x102，MARK set 0x102就是表示IPVS会进行负载均衡</li>
<li>查看IPVS的具体情况，我们先退出这个namespace，在本机环境里面安装ipvsadm，sudo yum install -y ipvsadm，然后再进入namespace</li>
<li>再次进入ingress_box这个netns，运行ipvsadm -l，就可以看到负载均衡的真实地址了。这里面的地址就是两个whoami的容器真实ip</li>
</ol>

<p>数据包走向：
<img src="https://liguoqinjim.cn/images/docker/note6/ingress2.png" alt="ingress_2" /></p>

<h1 id="7-docker-stack部署wordpress">7.Docker Stack部署Wordpress</h1>

<p>简单的说，stack就是通过文件来启动一系列service，而不是我们用命令一个个的去生成。<br />
具体是用docker-compose file里面的deploy可以实现，具体的yml规则可以看下面的连接。
<a href="https://docs.docker.com/engine/reference/commandline/stack_deploy/">https://docs.docker.com/engine/reference/commandline/stack_deploy/</a></p>

<p>命令：</p>

<ol>
<li>docker stack deploy wordpress &ndash;compose-file=docker-compose.yml，创建一个stack，stack的name是wordpress，&ndash;compose-file用来指定yml配置文件,也可以是-c</li>
<li>docker stack ls，查看现在的stack</li>
<li>docker stack ps wordpress，查看stack的具体情况</li>
<li>docker stack services wordpress，查看stack里面的service，可以看到绑定的端口</li>
<li>docker stack rm wordpress，删除stack</li>
</ol>

<p>docker-compose.yml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">version : <span style="color:#e6db74">&#39;3&#39;</span>

services:
  web:
    image: wordpress
    ports:
     - <span style="color:#ae81ff">8080</span>:<span style="color:#ae81ff">80</span>
    environment:
      WORDPRESS_DB_HOST: mysql
      WORDPRESS_DB_PASSWORD: xphone123
    networks:
      - my-network
    depends_on:
      - mysql
    deploy:
      mode: replicated
      replicas: <span style="color:#ae81ff">3</span> <span style="color:#75715e">#replicas个数为3</span>
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: <span style="color:#ae81ff">3</span>
      update_config:
        parallelism: <span style="color:#ae81ff">1</span>
        delay: 10s
  
  mysql:
    image: mysql
    environment:
      MYSQL_ROOT_PASSWORD: xphone123
      MYSQL_DATABASE: wordpress
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - my-network
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager <span style="color:#75715e"># 这个service的容器要运行在manager节点上</span>

<span style="color:#75715e"># 指定volume</span>
volumes:
  mysql-data:

<span style="color:#75715e"># 指定network</span>
networks:
  my-network:
    driver: overlay <span style="color:#75715e">#type是overlay</span></code></pre></div>
<h1 id="8-作业解答之部署投票应用">8.作业解答之部署投票应用</h1>

<p>具体docker-compose.yml可以查看docker-labs</p>

<h2 id="8-1stack可视化">8.1stack可视化</h2>

<p>dockersamples/visualizer:stable，使用这个镜像，可以可视化整个stack</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e">#这个service的配置</span>
visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - <span style="color:#e6db74">&#34;8080:8080&#34;</span>
    stop_grace_period: 1m30s
    volumes:
      - <span style="color:#e6db74">&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>
    deploy:
      placement:
        constraints: [node.role == manager]</code></pre></div>
<h1 id="9-docker-secret管理和使用">9.Docker Secret管理和使用</h1>

<h2 id="9-1什么是secret">9.1什么是Secret</h2>

<p><img src="https://liguoqinjim.cn/images/docker/note6/secret.png" alt="secret" />
这些我们都可以存到docker secret里面</p>

<h2 id="9-2secret存在哪里">9.2Secret存在哪里</h2>

<p><img src="https://liguoqinjim.cn/images/docker/note6/secret2.png" alt="secret_2" /></p>

<p><img src="https://liguoqinjim.cn/images/docker/note6/secret3.png" alt="secret_3" /></p>

<h2 id="9-3使用方法">9.3使用方法</h2>

<p>相关命令：</p>

<ul>
<li>从文件创建<br />
docker secret create my-pw password,这个password是一个文件，注意，我们创建好了docker secret之后，要把这个文件删掉</li>
<li>从输入流创建<br />
echo &ldquo;adminadmin&rdquo; | docker secret create my-pw2 -，注意最后的<code>-</code></li>
<li>docker secret ls，查看所有的secert</li>
<li>docker secret rm secret_name，删除secret</li>
<li>docker service create &ndash;name client &ndash;secret my-pw busybox sh -c &ldquo;while true; do sleep 3600; done&rdquo;，启动一个service，&ndash;secret指定这个service可以读取的secret，可以指定多个</li>
<li>cat /run/secrets/my-pw，我们在容器内部的这个路径，就可以读取到对应的secret了</li>
<li>比如我们启动的mysql容器的时候，需要指定数据库密码，我们使用-e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/my-pw，这样就可以读取到我们写在docker secret里面的密码了</li>
</ul>

<h1 id="10-docker-secret在stack中的使用">10.Docker Secret在Stack中的使用</h1>

<p>docker-compose.yml配置文件里面虽然可以写上secret的配置，可以去读取一个文件然后自动生成一个docker secret。但是毕竟这样的方式会存在文件，会不安全。所以开始推荐要用的时候先在命令行里面手动创建docker secret</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># 使用文件创建secret，不推荐这种方式</span>
secrets:
  my-pw:
    file: ./password

<span style="color:#75715e"># 在启动之前先手动创建secret，推荐这种方式</span>
secrets:
  mysql-pw:
    external: <span style="color:#66d9ef">true</span></code></pre></div>
<h1 id="11-service更新">11.Service更新</h1>

<p>对service可以更新很多内容，比如更新镜像(镜像里面的代码逻辑需要更新比如)，容器端口的更新</p>

<h2 id="11-1更新镜像">11.1更新镜像：</h2>

<ol>
<li>更新之前，为了使得我们现在的服务不会因为更新而不能访问(因为swarm集群里面的节点，一般都是生产环境，所以最好是不要有服务中断的情况)，所以我们应该先对service进行scale，比如web的service，可以scale=2，那样就会有两个容器在服务</li>
<li>开始更新镜像，镜像的更新会一个一个来进行，因为我们已经做了scale了，所以服务不会中断，docker service update &ndash;image new_image_new web，这里的web是service的name。因为会一个一个更新，所以会出现一个容器是老的镜像，还有一个容器是新的镜像的时刻。</li>
</ol>

<h2 id="11-2更新端口">11.2更新端口：</h2>

<p>更新端口可以通过先删去老的端口，然后加上新的端口来实现。
docker service update &ndash;publish-rm 8080:5000 &ndash;publish-add 8088:5000
这样就把原来的8080端口换到了8088端口，更新端口的时候，服务是会中断的，不会像更新镜像的时候一样，因为service都用一个VIP，然后VIP会负载均衡。那么更新端口的时候，VIP的端口会改变，所以服务会中断</p>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://liguoqinjim.cn/tags/docker/">docker</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E4%B8%83/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">系统学习Docker 践行DevOps理念 笔记(七)|容器编排Kubernetes</span>
            <span class="prev-text nav-mobile"></span>
          </a>
        
          <a class="next" href="https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E4%BA%94/">
            <span class="next-text nav-default">系统学习Docker 践行DevOps理念 笔记(五)|Docker Compose多容器部署</span>
            <span class="prev-text nav-mobile"></span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://liguoqinjim.cn/post/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker-%E8%B7%B5%E8%A1%8Cdevops%E7%90%86%E5%BF%B5-%E7%AC%94%E8%AE%B0%E5%85%AD/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'liguoqinjim';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


<a href="https://liguoqinjim.cn/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.
        
      </span></span>

  
  

  
    <span>
      <a href='http://www.beian.miit.gov.cn'>沪ICP备19042199号-1</a>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="https://liguoqinjim.cn/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://liguoqinjim.cn/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="https://liguoqinjim.cn/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>


























</body>
</html>
